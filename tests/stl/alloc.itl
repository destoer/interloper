

func test_arena() bool
{
    buf : byte[1024];
    arena : Arena = make_arena(buf);

    vla : byte[] = byte_arr_arena(&arena,25);

    for [@v , i] in vla
    {
        @v = cast(byte,i);
    }

    res := vla.len * vla[3];

    return res == 75;
}

func test_heap() bool
{
    print("before alloc:\n");
    heap_usage(&global_heap);


    vla : byte[] = byte_arr_heap(&global_heap,25);

    print("after alloc:\n");
    heap_usage(&global_heap);

    for [@v , i] in vla
    {
        @v = cast(byte,i * 2);
    }

    res := vla.len * vla[3];

    destroy_arr_heap<byte>(&global_heap,&vla);
    
    print("after free:\n");
    heap_usage(&global_heap);

    // check data is also free
    return res == 150 && vla.data == NULL && vla.len == 0;
}

func test_realloc() bool
{
    vla : byte[];
    array_realloc<byte>(&global_heap,&vla,100);

    for(i in 0 < 5)
    {
        array_realloc<byte>(&global_heap,&vla,vla.len * 2);

        for([@v , j] in vla)
        {
            @v = cast(byte,j);
        }

        print("alloc round {}\n",i);
        heap_usage(&global_heap);
    }

    res := vla.len;

    destroy_arr_heap<byte>(&global_heap,&vla);

    return res == 3200;
}

func main() s32
{
    pass := test_arena() && test_heap() && test_realloc();

    return cast(s32,pass);
}